name: Enforce Scripts Freeze

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  check_frozen_folder:
    runs-on: ubuntu-latest
    steps:
      # --- FIX 1: Checkout the Repository ---
      - name: Checkout Repository
        uses: actions/checkout@v4
        # We need to fetch enough history for the 'push' event to compare the current commit vs. the previous one.
        with:
          fetch-depth: 2 
          
      # --- FIX 2: Simplify and Correct inputs for tj-actions/changed-files ---
      - name: Get Changed Files
        id: files
        uses: tj-actions/changed-files@v44

      - name: Check for Modifications in Frozen Folder
        id: path_check
        run: |
          FROZEN_PATH="cloud/scripts/"
          MODIFIED="false"
          
          # Check all changed files for matches within the frozen path
          # We now check both added, modified, and deleted files for safety
          ALL_FILES="${{ steps.files.outputs.added_files }} ${{ steps.files.outputs.modified_files }} ${{ steps.files.outputs.deleted_files }}"
          
          for file in $ALL_FILES; do
            if [[ "$file" == $FROZEN_PATH* ]]; then
              echo "::error file=$file::Modification blocked: This folder is a read-only mirror and cannot be modified directly."
              MODIFIED="true"
            fi
          done
          
          echo "modification_detected=$MODIFIED" >> $GITHUB_OUTPUT

      - name: Fail if frozen folder was modified
        # This step is dependent on the output from the previous step
        if: steps.path_check.outputs.modification_detected == 'true'
        run: |
          echo "‚ùå PUSH BLOCKED: Cannot commit changes to the 'cloud/scripts/' folder. This is an automated mirror."
          # This command is what forces the workflow to fail, thus rejecting the push.
          exit 1