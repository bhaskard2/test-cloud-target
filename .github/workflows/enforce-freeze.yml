name: Enforce Scripts Freeze

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  check_frozen_folder:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2 
          
      - name: Get Changed Files
        id: files
        uses: tj-actions/changed-files@v44
        
      - name: Check for Modifications in Frozen Folder
        id: path_check
        run: |
          # The exact path that MUST be protected
          FROZEN_PATH="cloud/"
          MODIFIED="false"
          
          # Combine all files reported as added, modified, or deleted
          ALL_FILES="${{ steps.files.outputs.added_files }} ${{ steps.files.outputs.modified_files }} ${{ steps.files.outputs.deleted_files }}"
          
          echo "Checking files for violations..."
          
          # Iterate through the files and check if the path starts with the protected prefix.
          for file in $ALL_FILES; do
            # Use BASH string comparison (not regex) to check for the literal prefix
            if [[ "$file" == $FROZEN_PATH* ]]; then
              echo "::error file=$file::Modification blocked: This folder ($FROZEN_PATH) is a read-only mirror and cannot be modified directly."
              MODIFIED="true"
              break # Stop checking and fail immediately
            else
              echo "Allowed change: $file"
            fi
          done
          
          echo "modification_detected=$MODIFIED" >> $GITHUB_OUTPUT

      - name: Fail if frozen folder was modified
        if: steps.path_check.outputs.modification_detected == 'true'
        run: |
          echo "‚ùå PUSH BLOCKED: Cannot commit changes to the 'cloud/' folder. This is an automated mirror."
          exit 1